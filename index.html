<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PayRadar | Alpha Hub</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --accent: #fbbf24; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f1f5f9;
            -webkit-tap-highlight-color: transparent;
            font-size: 11px;
            overflow-x: hidden;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .gold-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-alpha {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-alpha:active { transform: scale(0.98); background: rgba(15, 23, 42, 0.9); }
        .bottom-sheet {
            background: #020617;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.9);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-btn {
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.35rem 0.7rem;
            border-radius: 0.4rem;
            transition: all 0.2s;
        }
        input, textarea, select { font-size: 16px !important; }
        .compact-input {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 11px !important;
            color: white;
            width: 100%;
            outline: none;
        }
        .compact-input:focus { border-color: rgba(251, 191, 36, 0.3); }
    </style>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
    "@google/genai": "https://esm.sh/@google/genai@1.34.0",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2.45.4",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo, useCallback, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { GoogleGenAI, Type } from "@google/genai";
        import { createClient } from '@supabase/supabase-js';

        const SUPABASE_URL = 'https://uqvhjtvypgcryclepwtx.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_D9DdcEhF9b7yet-1tgv27Q_yDkMkZo8';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const ADMIN_PASS = "ADMIN_2026_SECURE";

        const aiService = {
            async getActiveKey() {
                // Check local storage (Admin manual entry)
                const localKey = localStorage.getItem('pr_admin_gemini_key');
                if (localKey && localKey.trim()) return localKey.trim();

                // Check Supabase
                try {
                    const { data } = await supabase.from('protocol_settings').select('gemini_api_key').single();
                    if (data?.gemini_api_key) return data.gemini_api_key.trim();
                } catch(e) {}
                
                // Environment fallback
                if (process.env.API_KEY && process.env.API_KEY !== 'undefined') return process.env.API_KEY;
                
                return null;
            },

            async fetchNewAlpha() {
                try {
                    const apiKey = await this.getActiveKey();
                    if (!apiKey) return null;
                    const ai = new GoogleGenAI({ apiKey });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `Find 5 NEW crypto/earning apps or sites that are currently paying. Return a JSON array with: name, category, reward, link, description.`,
                        config: { tools: [{ googleSearch: {} }], responseMimeType: "application/json" }
                    });
                    return JSON.parse(response.text);
                } catch (e) { return null; }
            },

            async auditSite(site) {
                try {
                    const apiKey = await this.getActiveKey();
                    if (!apiKey) return "ENGINE OFFLINE: Configure Gemini API Key in Admin.";

                    const ai = new GoogleGenAI({ apiKey });
                    const response = await ai.models.generateContent({
                        model: 'gemini-3-flash-preview',
                        contents: `Search the web for recent withdrawal proofs of "${site}". Is it currently legit and paying? Verdict: LEGIT or SCAM.`,
                        config: { tools: [{ googleSearch: {} }] }
                    });
                    
                    const sources = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
                    const links = sources.filter(c => c.web?.uri).map(c => `\nðŸ”— [${c.web.title}](${c.web.uri})`).join('');
                    return response.text + (links ? `\n\n**Sources:**${links}` : '');
                } catch (e) { 
                    // Improved debugging
                    const errorMsg = e.message || "Unknown Connection Error";
                    if (errorMsg.includes("billing")) return "ERROR: Google Search tool requires a Billing Project linked to your API Key (even for free tier). Check AI Studio settings.";
                    if (errorMsg.includes("API key not valid")) return "ERROR: Invalid API Key. Please re-enter in Admin Terminal.";
                    return "Neural Link Error: " + errorMsg;
                }
            }
        };

        const AdminTerminal = ({ onExit }) => {
            const [isAuth, setIsAuth] = useState(false);
            const [pass, setPass] = useState('');
            const [adCode, setAdCode] = useState(localStorage.getItem('pr_admin_ad_code') || '');
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('pr_admin_gemini_key') || '');
            const [signals, setSignals] = useState([]);
            const [manual, setManual] = useState({ name: '', category: 'Airdrop', reward: '', link: '', description: '', guide: '' });
            const [saving, setSaving] = useState(false);

            useEffect(() => {
                if (isAuth) {
                    supabase.from('opportunities').select('*').order('created_at', { ascending: false }).limit(50).then(res => setSignals(res.data || []));
                    supabase.from('protocol_settings').select('ad_code, gemini_api_key').single().then(res => {
                        if (res.data) {
                            if (!adCode) setAdCode(res.data.ad_code || '');
                            if (!geminiKey) setGeminiKey(res.data.gemini_api_key || '');
                        }
                    });
                }
                    }, [isAuth]);

            const saveProtocol = async () => {
                setSaving(true);
                localStorage.setItem('pr_admin_ad_code', adCode);
                localStorage.setItem('pr_admin_gemini_key', geminiKey.trim());
                await supabase.from('protocol_settings').upsert({ id: 1, ad_code: adCode, gemini_api_key: geminiKey.trim() });
                setSaving(false);
                alert("PROTOCOLS SECURED LOCALLY & SYNCED.");
            };

            const addManual = async () => {
                const { error } = await supabase.from('opportunities').insert([manual]);
                if (!error) { alert("BROADCASTED."); setManual({ name: '', category: 'Airdrop', reward: '', link: '', description: '', guide: '' }); }
            };

            if (!isAuth) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-950 font-mono">
                        <div className="w-12 h-12 bg-yellow-500 rounded-xl mb-6 flex items-center justify-center font-black text-black">PR</div>
                        <input type="password" value={pass} onChange={e => setPass(e.target.value)} placeholder="Passcode" className="compact-input text-center mb-4 max-w-[180px]" />
                        <button onClick={() => pass === ADMIN_PASS && setIsAuth(true)} className="bg-yellow-500 text-black px-8 py-3 rounded-lg font-black text-[10px] uppercase">Authorize Terminal</button>
                    </div>
                );
            }

            return (
                <div className="p-4 space-y-6 max-w-md mx-auto pb-32 animate-in fade-in">
                    <header className="flex justify-between items-center"><h2 className="font-black gold-gradient italic uppercase">Hub Overwatch</h2><button onClick={onExit} className="text-[9px] text-slate-500">EXIT</button></header>
                    <section className="card-alpha p-4 space-y-4">
                        <div>
                            <h3 className="text-[9px] font-black text-slate-400 uppercase mb-2">Neural Link (API Key)</h3>
                            <input type="text" value={geminiKey} onChange={e => setGeminiKey(e.target.value)} className="compact-input font-mono text-[10px]" placeholder="sk-..." />
                        </div>
                        <div>
                            <h3 className="text-[9px] font-black text-slate-400 uppercase mb-2">Ad Code</h3>
                            <textarea value={adCode} onChange={e => setAdCode(e.target.value)} className="compact-input h-24 font-mono text-[9px]" placeholder="Paste script..." />
                        </div>
                        <button onClick={saveProtocol} disabled={saving} className="w-full bg-white text-black py-4 rounded-xl text-[9px] font-black uppercase shadow-xl">{saving ? 'LOCKING...' : 'Update Protocols'}</button>
                    </section>
                    <section className="card-alpha p-4 space-y-2">
                        <h3 className="text-[9px] font-black text-slate-400 uppercase mb-2">Manual Signal</h3>
                        <input value={manual.name} onChange={e => setManual({...manual, name: e.target.value})} placeholder="Project Name" className="compact-input" />
                        <input value={manual.reward} onChange={e => setManual({...manual, reward: e.target.value})} placeholder="Reward" className="compact-input" />
                        <input value={manual.link} onChange={e => setManual({...manual, link: e.target.value})} placeholder="Link" className="compact-input" />
                        <button onClick={addManual} className="w-full bg-yellow-500 text-black py-3 rounded-xl text-[9px] font-black uppercase">Push Signal</button>
                    </section>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('feed');
            const [isAdmin] = useState(window.location.search.includes('admin'));
            const [signals, setSignals] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selected, setSelected] = useState(null);
            const [auditQ, setAuditQ] = useState('');
            const [auditR, setAuditR] = useState('');
            const [auditing, setAuditing] = useState(false);
            const [activeTab, setActiveTab] = useState('ALL');

            const fetchFeed = useCallback(async () => {
                const { data } = await supabase.from('opportunities').select('*').order('created_at', { ascending: false }).limit(100);
                if (data) setSignals(data);
                setLoading(false);
            }, []);

            useEffect(() => {
                const alphaRoutine = async () => {
                    const res = await aiService.fetchNewAlpha();
                    if (res && Array.isArray(res)) {
                        for (const item of res) {
                            const { data } = await supabase.from('opportunities').select('id').eq('name', item.name).maybeSingle();
                            if (!data) await supabase.from('opportunities').insert([item]);
                        }
                        fetchFeed();
                    }
                };
                alphaRoutine();
                const interval = setInterval(alphaRoutine, 3600000);
                return () => clearInterval(interval);
            }, [fetchFeed]);

            useEffect(() => {
                fetchFeed();
                let adBox = null;
                const localAd = localStorage.getItem('pr_admin_ad_code');
                if (localAd && !isAdmin) {
                    adBox = document.createElement('div');
                    adBox.className = 'fixed bottom-12 left-0 right-0 z-40 text-center scale-[0.7] opacity-40';
                    adBox.innerHTML = localAd;
                    document.body.appendChild(adBox);
                    Array.from(adBox.getElementsByTagName('script')).forEach(s => {
                        const ns = document.createElement('script');
                        if (s.src) ns.src = s.src; else ns.textContent = s.textContent;
                        document.body.appendChild(ns);
                    });
                }
                return () => adBox && adBox.remove();
            }, [fetchFeed, isAdmin]);

            const runAudit = async () => {
                if (!auditQ) return;
                setAuditing(true); setAuditR('');
                const res = await aiService.auditSite(auditQ);
                setAuditR(res); setAuditing(false);
            };

            const filtered = useMemo(() => signals.filter(s => activeTab === 'ALL' || s.category.toUpperCase() === activeTab), [signals, activeTab]);

            if (isAdmin) return <AdminTerminal onExit={() => window.location.href = window.location.pathname} />;

            return (
                <div className="max-w-md mx-auto min-h-screen relative pb-20">
                    <nav className="fixed top-0 left-0 right-0 h-10 bg-slate-950/80 backdrop-blur-xl border-b border-white/5 px-4 flex items-center justify-between z-50 max-w-md mx-auto">
                        <div className="flex items-center gap-1.5"><div className="w-5 h-5 bg-yellow-500 rounded flex items-center justify-center font-black text-[9px] text-black italic">PR</div><span className="font-black text-[10px] gold-gradient italic uppercase tracking-tighter">PayRadar Alpha</span></div>
                        <div className="flex gap-4">
                            <button onClick={() => setView('feed')} className={`text-[8px] font-black uppercase ${view === 'feed' ? 'text-yellow-500' : 'text-slate-500'}`}>Alpha</button>
                            <button onClick={() => setView('audit')} className={`text-[8px] font-black uppercase ${view === 'audit' ? 'text-yellow-500' : 'text-slate-500'}`}>Audit</button>
                        </div>
                    </nav>
                    <main className="mt-12 p-3 space-y-4">
                        {view === 'feed' ? (
                            <div className="animate-in slide-in-from-bottom-2">
                                <header className="mb-4"><h1 className="text-xl font-black italic uppercase text-white">L100 <span className="gold-gradient">Feed.</span></h1></header>
                                <div className="flex gap-1 overflow-x-auto hide-scrollbar mb-4">{['ALL', 'AIRDROP', 'REFERRAL', 'TASK'].map(t => (<button key={t} onClick={() => setActiveTab(t)} className={`tab-btn whitespace-nowrap ${activeTab === t ? 'bg-yellow-500 text-black' : 'bg-slate-900 text-slate-500'}`}>{t}</button>))}</div>
                                <div className="space-y-1.5">
                                    {loading ? <div className="py-20 text-center opacity-20 text-[9px] font-black animate-pulse">Scanning...</div> : 
                                    filtered.map(sig => (
                                        <div key={sig.id} onClick={() => setSelected(sig)} className="card-alpha p-3 flex justify-between items-center group cursor-pointer border-white/5">
                                            <div><span className="text-[10px] font-black text-white group-hover:text-yellow-500 uppercase italic block">{sig.name}</span><span className="text-[8px] font-mono text-yellow-500/80 uppercase">{sig.reward}</span></div>
                                            <span className="text-[8px] font-bold text-slate-500 uppercase">Intel â†’</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="animate-in slide-in-from-right-2">
                                <header className="mb-6"><h1 className="text-xl font-black italic uppercase text-white">Neural <span className="gold-gradient">Audit.</span></h1></header>
                                <div className="card-alpha p-4 space-y-3">
                                    <input value={auditQ} onChange={e => setAuditQ(e.target.value)} onKeyDown={e => e.key === 'Enter' && runAudit()} placeholder="Check project..." className="compact-input" />
                                    <button onClick={runAudit} disabled={auditing} className="w-full bg-white text-black font-black py-4 rounded-xl text-[9px] shadow-xl">{auditing ? 'Vetting...' : 'Scan Neural Link'}</button>
                                </div>
                                {auditR && <div className="mt-4 bg-slate-900/40 p-4 rounded-xl border border-white/5 text-[9px] font-mono text-slate-300 whitespace-pre-wrap">{auditR}</div>}
                            </div>
                        )}
                    </main>
                    {selected && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center bg-black/70 backdrop-blur-sm" onClick={() => setSelected(null)}>
                            <div className="w-full max-w-md bottom-sheet p-5 space-y-4 animate-in slide-in-from-bottom-10" onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-black text-white italic uppercase">{selected.name}</h2>
                                <div className="space-y-4 text-[10px]">
                                    <div className="bg-slate-900/50 p-4 rounded-2xl border border-white/5"><p className="text-slate-300 leading-relaxed">{selected.description}</p></div>
                                    <div className="pt-4"><a href={selected.link} target="_blank" className="block w-full text-center py-4 bg-white text-black font-black rounded-xl uppercase">Claim Alpha Access</a></div>
                                </div>
                            </div>
                        </div>
                    )}
                    <footer className="fixed bottom-0 left-0 right-0 h-8 border-t border-white/5 bg-slate-950 flex items-center justify-center z-40 max-w-md mx-auto"><p className="text-[7px] text-slate-800 font-black uppercase italic">Â© 2026 PayRadar â€¢ <a href="?admin=true">Terminal Auth</a></p></footer>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
    
